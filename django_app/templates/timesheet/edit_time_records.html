{% extends "base.html" %}
{% load timesheet_tags %}

{% block extra_head %}
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block content %}
<div class="min-h-screen px-4 py-4 max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex items-center gap-3 mb-4">
        <a href="{% url 'admin_dashboard' %}" class="text-accent-primary text-base font-medium hover:text-accent-secondary transition-colors flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Back
        </a>
        <h1 class="flex-1 flex items-center gap-2 font-grotesk text-lg font-bold text-slate-900">
            <div class="p-1 bg-accent-primary/10 rounded-lg">
                <svg class="w-4 h-4 text-accent-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
            </div>
            Edit Time Records
        </h1>
    </div>

    <!-- Filters -->
    <div class="mb-3 bg-white border border-slate-200 rounded-lg p-3 shadow-sm">
        <form id="editRecordsFilterForm" method="GET" action="{% url 'edit_time_records' %}" class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <div>
                <label class="block text-[10px] font-semibold text-slate-700 mb-1 uppercase tracking-wide">Employee</label>
                <select name="employee" class="w-full p-2 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-accent-primary focus:border-accent-primary text-sm">
                    <option value="">All Employees</option>
                    {% for emp in employees %}
                    <option value="{{ emp.id }}" {% if filters.employee == emp.id %}selected{% endif %}>{{ emp.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label class="block text-[10px] font-semibold text-slate-700 mb-1 uppercase tracking-wide">Date From</label>
                <input type="date" name="date_from" value="{{ filters.date_from }}" class="w-full p-2 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-accent-primary focus:border-accent-primary text-sm">
            </div>
            
            <div>
                <label class="block text-[10px] font-semibold text-slate-700 mb-1 uppercase tracking-wide">Date To</label>
                <input type="date" name="date_to" value="{{ filters.date_to }}" class="w-full p-2 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-accent-primary focus:border-accent-primary text-sm">
            </div>
            
            <div>
                <label class="block text-[10px] font-semibold text-slate-700 mb-1 uppercase tracking-wide">Type</label>
                <select name="is_non_productive" class="w-full p-2 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-accent-primary focus:border-accent-primary text-sm">
                    <option value="">All</option>
                    <option value="false" {% if filters.is_non_productive == 'false' %}selected{% endif %}>Productive</option>
                    <option value="true" {% if filters.is_non_productive == 'true' %}selected{% endif %}>Non-Productive</option>
                </select>
            </div>
            
            <div class="md:col-span-4 flex gap-2 items-end">
                <button type="submit" class="px-4 py-2 bg-accent-primary text-white rounded-lg text-sm font-semibold hover:bg-opacity-90 transition-colors">
                    Apply Filters
                </button>
                <a href="{% url 'edit_time_records' %}" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg text-sm font-semibold hover:bg-slate-300 transition-colors">
                    Clear Filters
                </a>
                <div class="flex-1"></div>
                <button 
                    type="button"
                    onclick="openAddRecordModal()"
                    class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700 transition-colors flex items-center gap-1.5">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Add New Record
                </button>
                <button 
                    type="button"
                    onclick="openTopupModal()"
                    class="px-4 py-2 bg-amber-600 text-white rounded-lg text-sm font-semibold hover:bg-amber-700 transition-colors flex items-center gap-1.5"
                    title="Suggest adding hours so days with 4–6.91h reach 6.91h, split by activity share">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Top-up to 6.91h
                </button>
                <button 
                    id="saveAllButton"
                    onclick="saveAllChanges()"
                    class="px-4 py-2 bg-gradient-to-r from-accent-primary to-accent-secondary text-white rounded-lg text-sm font-semibold hover:shadow-lg hover:scale-[1.02] transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 disabled:hover:shadow-none">
                    <span id="saveAllText">Save All Changes</span>
                </button>
            </div>
        </form>
        <div id="saveMessage" class="mt-3 text-sm text-center hidden"></div>
    </div>

    <!-- Add Record Modal -->
    <div id="addRecordModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-slate-900">Add New Time Record</h2>
                    <button onclick="closeAddRecordModal()" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <form id="addRecordForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Date *</label>
                            <input type="date" name="date" required class="w-full p-2.5 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-accent-primary focus:border-accent-primary">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Employee *</label>
                            <select name="employee_id" required class="w-full p-2.5 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-accent-primary focus:border-accent-primary">
                                <option value="">Select Employee</option>
                                {% for emp in employees %}
                                <option value="{{ emp.id }}">{{ emp.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Project</label>
                            <select name="project_id" id="addRecordProject" class="w-full p-2.5 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-accent-primary focus:border-accent-primary">
                                <option value="">- No Project -</option>
                                {% for proj in projects %}
                                <option value="{{ proj.id }}">{{ proj.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Task *</label>
                            <select name="task" id="addRecordTask" required class="w-full p-2.5 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-accent-primary focus:border-accent-primary">
                                <option value="">Select Task</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Start Time *</label>
                            <input type="time" name="start_time" required class="w-full p-2.5 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-accent-primary focus:border-accent-primary">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">End Time</label>
                            <input type="time" name="end_time" class="w-full p-2.5 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-accent-primary focus:border-accent-primary">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Hours</label>
                            <input type="number" step="0.01" min="0" name="duration_hours" class="w-full p-2.5 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-accent-primary focus:border-accent-primary" placeholder="0.00">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Type *</label>
                            <select name="is_non_productive" id="addRecordType" required class="w-full p-2.5 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-accent-primary focus:border-accent-primary">
                                <option value="false">Productive</option>
                                <option value="true">Non-Productive</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 px-6 py-2.5 bg-accent-primary text-white rounded-lg font-semibold hover:bg-opacity-90 transition-colors">
                            Add Record
                        </button>
                        <button type="button" onclick="closeAddRecordModal()" class="px-6 py-2.5 bg-slate-200 text-slate-700 rounded-lg font-semibold hover:bg-slate-300 transition-colors">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Top-up to 6.91h Modal -->
    <div id="topupModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b border-slate-200">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-bold text-slate-900">Top-up to 6.91h per day</h2>
                        <p class="text-sm text-slate-600 mt-1">Days with 4–6.91 hours get the remaining hours split by each activity’s share. &lt;4h or ≥6.91h are unchanged.</p>
                    </div>
                    <button type="button" onclick="closeTopupModal()" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>
            <div id="topupContent" class="p-6 overflow-y-auto flex-1">
                <div id="topupLoading" class="text-center py-8 text-slate-500">Loading…</div>
                <div id="topupEmpty" class="hidden text-center py-8 text-slate-600">No records need top-up in the current filter (4h &lt; total &lt; 6.91h).</div>
                <div id="topupTableWrap" class="hidden">
                    <p id="topupSummary" class="text-sm text-slate-600 mb-3"></p>
                    <div class="overflow-x-auto border border-slate-200 rounded-lg">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-50 border-b border-slate-200">
                                <tr>
                                    <th class="px-2 py-2 text-left text-xs font-semibold text-slate-700 uppercase">Employee</th>
                                    <th class="px-2 py-2 text-left text-xs font-semibold text-slate-700 uppercase">Date</th>
                                    <th class="px-2 py-2 text-left text-xs font-semibold text-slate-700 uppercase">Task</th>
                                    <th class="px-2 py-2 text-left text-xs font-semibold text-slate-700 uppercase">Project</th>
                                    <th class="px-2 py-2 text-left text-xs font-semibold text-slate-700 uppercase">Type</th>
                                    <th class="px-2 py-2 text-right text-xs font-semibold text-slate-700 uppercase">Current</th>
                                    <th class="px-2 py-2 text-right text-xs font-semibold text-slate-700 uppercase">Add</th>
                                    <th class="px-2 py-2 text-right text-xs font-semibold text-slate-700 uppercase">New</th>
                                </tr>
                            </thead>
                            <tbody id="topupTableBody" class="divide-y divide-slate-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="topupFooter" class="p-6 border-t border-slate-200 hidden flex gap-3 justify-end">
                <button type="button" onclick="closeTopupModal()" class="px-6 py-2.5 bg-slate-200 text-slate-700 rounded-lg font-semibold hover:bg-slate-300 transition-colors">Cancel</button>
                <button type="button" id="topupApplyBtn" onclick="applyTopup()" class="px-6 py-2.5 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 transition-colors">Apply</button>
            </div>
        </div>
    </div>

    <!-- Summary Section -->
    <div class="mb-3 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-2.5 shadow-sm">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <div class="text-center">
                <div class="text-[10px] font-semibold text-slate-600 uppercase tracking-wide mb-0.5">Records</div>
                <div class="text-lg font-bold text-slate-900">{{ summary.total_records }}</div>
            </div>
            <div class="text-center">
                <div class="text-[10px] font-semibold text-slate-600 uppercase tracking-wide mb-0.5">Total Hours</div>
                <div class="text-lg font-bold text-blue-700">{{ summary.total_hours|floatformat:2 }}</div>
            </div>
            <div class="text-center">
                <div class="text-[10px] font-semibold text-slate-600 uppercase tracking-wide mb-0.5">Productive</div>
                <div class="text-lg font-bold text-green-700">{{ summary.total_productive_hours|floatformat:2 }}</div>
            </div>
            <div class="text-center">
                <div class="text-[10px] font-semibold text-slate-600 uppercase tracking-wide mb-0.5">Non-Prod</div>
                <div class="text-lg font-bold text-orange-700">{{ summary.total_non_productive_hours|floatformat:2 }}</div>
            </div>
        </div>
    </div>

    <!-- Records Table -->
    <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <div class="max-h-[calc(100vh-350px)] overflow-y-auto">
                <table class="w-full text-sm">
                    <thead class="bg-slate-50 border-b border-slate-200 sticky top-0 z-10">
                        <tr>
                            <th class="px-2 py-1.5 text-left text-xs font-semibold text-slate-700 uppercase tracking-wide sortable cursor-pointer hover:bg-slate-100 transition-colors" data-sort="date" data-sort-type="date">
                                <div class="flex items-center gap-1">
                                    <span>Date</span>
                                    <span class="sort-indicator text-slate-400"></span>
                                </div>
                            </th>
                            <th class="px-2 py-1.5 text-left text-xs font-semibold text-slate-700 uppercase tracking-wide sortable cursor-pointer hover:bg-slate-100 transition-colors" data-sort="employee" data-sort-type="text">
                                <div class="flex items-center gap-1">
                                    <span>Employee</span>
                                    <span class="sort-indicator text-slate-400"></span>
                                </div>
                            </th>
                            <th class="px-2 py-1.5 text-left text-xs font-semibold text-slate-700 uppercase tracking-wide sortable cursor-pointer hover:bg-slate-100 transition-colors" data-sort="project" data-sort-type="text">
                                <div class="flex items-center gap-1">
                                    <span>Project</span>
                                    <span class="sort-indicator text-slate-400"></span>
                                </div>
                            </th>
                            <th class="px-2 py-1.5 text-left text-xs font-semibold text-slate-700 uppercase tracking-wide sortable cursor-pointer hover:bg-slate-100 transition-colors" data-sort="task" data-sort-type="text">
                                <div class="flex items-center gap-1">
                                    <span>Task</span>
                                    <span class="sort-indicator text-slate-400"></span>
                                </div>
                            </th>
                            <th class="px-2 py-1.5 text-left text-xs font-semibold text-slate-700 uppercase tracking-wide sortable cursor-pointer hover:bg-slate-100 transition-colors" data-sort="start_time" data-sort-type="time">
                                <div class="flex items-center gap-1">
                                    <span>Start</span>
                                    <span class="sort-indicator text-slate-400"></span>
                                </div>
                            </th>
                            <th class="px-2 py-1.5 text-left text-xs font-semibold text-slate-700 uppercase tracking-wide sortable cursor-pointer hover:bg-slate-100 transition-colors" data-sort="end_time" data-sort-type="time">
                                <div class="flex items-center gap-1">
                                    <span>End</span>
                                    <span class="sort-indicator text-slate-400"></span>
                                </div>
                            </th>
                            <th class="px-2 py-1.5 text-left text-xs font-semibold text-slate-700 uppercase tracking-wide sortable cursor-pointer hover:bg-slate-100 transition-colors" data-sort="hours" data-sort-type="number">
                                <div class="flex items-center gap-1">
                                    <span>Hours</span>
                                    <span class="sort-indicator text-slate-400"></span>
                                </div>
                            </th>
                            <th class="px-2 py-1.5 text-left text-xs font-semibold text-slate-700 uppercase tracking-wide sortable cursor-pointer hover:bg-slate-100 transition-colors" data-sort="type" data-sort-type="text">
                                <div class="flex items-center gap-1">
                                    <span>Type</span>
                                    <span class="sort-indicator text-slate-400"></span>
                                </div>
                            </th>
                            <th class="px-2 py-1.5 text-left text-xs font-semibold text-slate-700 uppercase tracking-wide">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200">
                    {% for record in records %}
                    <tr class="hover:bg-slate-50 transition-colors" data-record-id="{{ record.id }}" data-is-non-prod="{{ record.is_non_productive|yesno:'true,false' }}">
                        <td class="px-2 py-1.5" data-sort-value="{{ record.date }}">
                            <input 
                                type="date" 
                                value="{{ record.date }}" 
                                class="editable-field editable-date w-full px-1.5 py-0.5 border border-slate-300 rounded focus:ring-1 focus:ring-accent-primary focus:border-accent-primary text-xs"
                                data-record-id="{{ record.id }}"
                                data-field="date"
                                data-original-value="{{ record.date }}"
                            />
                        </td>
                        <td class="px-2 py-1.5" data-sort-value="{{ record.employee_name|upper }}">
                            <select 
                                class="editable-field editable-employee w-full px-1.5 py-0.5 border border-slate-300 rounded focus:ring-1 focus:ring-accent-primary focus:border-accent-primary text-xs"
                                data-record-id="{{ record.id }}"
                                data-field="employee_id"
                                data-original-value="{{ record.employee_id }}"
                            >
                                {% for emp in employees %}
                                <option value="{{ emp.id }}" {% if record.employee_id == emp.id %}selected{% endif %}>{{ emp.name }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class="px-2 py-1.5" data-sort-value="{{ record.project_name|default:'ZZZZZZZZZZ'|upper }}">
                            <select 
                                class="editable-field editable-project w-full px-1.5 py-0.5 border border-slate-300 rounded focus:ring-1 focus:ring-accent-primary focus:border-accent-primary text-xs {% if record.is_non_productive %}bg-slate-100 cursor-not-allowed opacity-60{% endif %}"
                                data-record-id="{{ record.id }}"
                                data-field="project_id"
                                data-original-value="{{ record.project_id }}"
                                {% if record.is_non_productive %}disabled{% endif %}
                                title="{% if record.is_non_productive %}Project is not editable for non-productive hours{% endif %}"
                            >
                                <option value="">- No Project -</option>
                                {% for proj in projects %}
                                <option value="{{ proj.id }}" {% if record.project_id == proj.id %}selected{% endif %}>{{ proj.name }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class="px-2 py-1.5" data-sort-value="{{ record.task|upper }}">
                            <select 
                                class="editable-field editable-task w-full px-1.5 py-0.5 border border-slate-300 rounded focus:ring-1 focus:ring-accent-primary focus:border-accent-primary text-xs"
                                data-record-id="{{ record.id }}"
                                data-field="task"
                                data-original-value="{{ record.task }}"
                            >
                                {% if record.is_non_productive %}
                                    {% for task in non_productive_tasks %}
                                    <option value="{{ task.name }}" {% if record.task == task.name %}selected{% endif %}>{{ task.name }}</option>
                                    {% endfor %}
                                {% else %}
                                    {% for task in productive_tasks %}
                                    <option value="{{ task.name }}" {% if record.task == task.name %}selected{% endif %}>{{ task.name }}</option>
                                    {% endfor %}
                                {% endif %}
                            </select>
                        </td>
                        <td class="px-2 py-1.5" data-sort-value="{{ record.start_time }}">
                            <input 
                                type="time" 
                                value="{{ record.start_time }}" 
                                class="editable-field editable-time w-full px-1.5 py-0.5 border border-slate-300 rounded focus:ring-1 focus:ring-accent-primary focus:border-accent-primary text-xs"
                                data-record-id="{{ record.id }}"
                                data-field="start_time"
                                data-original-value="{{ record.start_time }}"
                            />
                        </td>
                        <td class="px-2 py-1.5" data-sort-value="{{ record.end_time }}">
                            <input 
                                type="time" 
                                value="{{ record.end_time }}" 
                                class="editable-field editable-time w-full px-1.5 py-0.5 border border-slate-300 rounded focus:ring-1 focus:ring-accent-primary focus:border-accent-primary text-xs"
                                data-record-id="{{ record.id }}"
                                data-field="end_time"
                                data-original-value="{{ record.end_time }}"
                            />
                        </td>
                        <td class="px-2 py-1.5" data-sort-value="{{ record.duration_hours }}">
                            <input 
                                type="number" 
                                step="0.01" 
                                min="0"
                                placeholder="{{ record.duration_hours|floatformat:2 }}"
                                value="{{ record.duration_hours|floatformat:2 }}"
                                class="editable-field editable-hours w-24 px-2 py-1 border border-slate-300 rounded focus:ring-1 focus:ring-accent-primary focus:border-accent-primary text-xs"
                                data-record-id="{{ record.id }}"
                                data-field="duration_hours"
                                data-original-value="{{ record.duration_hours|floatformat:2 }}"
                                data-calculated-hours="{% if record.calculated_hours is not None %}{{ record.calculated_hours|floatformat:2 }}{% else %}{{ record.duration_hours|floatformat:2 }}{% endif %}"
                            />
                        </td>
                        <td class="px-2 py-1.5" data-sort-value="{% if record.is_non_productive %}1{% else %}0{% endif %}">
                            <span class="px-1.5 py-0.5 rounded-full text-[10px] font-semibold {% if record.is_non_productive %}bg-orange-100 text-orange-700{% else %}bg-green-100 text-green-700{% endif %}">
                                {% if record.is_non_productive %}Non-Prod{% else %}Productive{% endif %}
                            </span>
                        </td>
                        <td class="px-2 py-1.5">
                            <button 
                                onclick="deleteRecord('{{ record.id }}')"
                                class="px-2 py-1 bg-red-100 text-red-700 rounded text-[10px] font-semibold hover:bg-red-200 transition-colors"
                                title="Delete record">
                                <svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="px-4 py-8 text-center text-slate-500 text-sm">No records found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>
        </div>
    </div>

</div>

<script>
let changedRecords = new Map(); // Map<recordId, {field: value}>
let deletedRecords = new Set(); // Set of record IDs to delete
let currentSort = { column: null, direction: null }; // Current sort state

// Sorting functionality
function initSorting() {
    document.querySelectorAll('.sortable').forEach(header => {
        header.addEventListener('click', function() {
            const column = this.dataset.sort;
            const sortType = this.dataset.sortType;
            
            // Determine sort direction
            let direction = 'asc';
            if (currentSort.column === column && currentSort.direction === 'asc') {
                direction = 'desc';
            }
            
            // Update sort state
            currentSort.column = column;
            currentSort.direction = direction;
            
            // Sort the table
            sortTable(column, direction, sortType);
            
            // Update sort indicators
            updateSortIndicators(column, direction);
        });
    });
}

function sortTable(column, direction, sortType) {
    const tbody = document.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr[data-record-id]'));
    
    // Get column index
    const headers = document.querySelectorAll('thead th');
    let columnIndex = -1;
    headers.forEach((header, index) => {
        if (header.dataset.sort === column) {
            columnIndex = index;
        }
    });
    
    if (columnIndex === -1) return;
    
    // Sort rows
    rows.sort((a, b) => {
        const aCell = a.querySelectorAll('td')[columnIndex];
        const bCell = b.querySelectorAll('td')[columnIndex];
        
        if (!aCell || !bCell) return 0;
        
        let aValue = aCell.dataset.sortValue || aCell.textContent.trim();
        let bValue = bCell.dataset.sortValue || bCell.textContent.trim();
        
        // Handle empty values
        if (!aValue || aValue === '-') aValue = sortType === 'number' ? -Infinity : 'ZZZZZZZZZZ';
        if (!bValue || bValue === '-') bValue = sortType === 'number' ? -Infinity : 'ZZZZZZZZZZ';
        
        let comparison = 0;
        
        switch (sortType) {
            case 'number':
                aValue = parseFloat(aValue) || 0;
                bValue = parseFloat(bValue) || 0;
                comparison = aValue - bValue;
                break;
            case 'date':
                comparison = new Date(aValue) - new Date(bValue);
                break;
            case 'time':
                // Convert time string to comparable format (HH:MM:SS)
                const aTime = aValue.split(':').map(Number);
                const bTime = bValue.split(':').map(Number);
                const aSeconds = (aTime[0] || 0) * 3600 + (aTime[1] || 0) * 60 + (aTime[2] || 0);
                const bSeconds = (bTime[0] || 0) * 3600 + (bTime[1] || 0) * 60 + (bTime[2] || 0);
                comparison = aSeconds - bSeconds;
                break;
            case 'text':
            default:
                comparison = aValue.localeCompare(bValue, undefined, { sensitivity: 'base' });
                break;
        }
        
        return direction === 'asc' ? comparison : -comparison;
    });
    
    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
}

function updateSortIndicators(activeColumn, direction) {
    // Clear all indicators
    document.querySelectorAll('.sort-indicator').forEach(indicator => {
        indicator.innerHTML = '';
        indicator.classList.remove('text-accent-primary', 'font-bold');
    });
    
    // Update active indicator
    const activeHeader = document.querySelector(`th[data-sort="${activeColumn}"]`);
    if (activeHeader) {
        const indicator = activeHeader.querySelector('.sort-indicator');
        if (indicator) {
            indicator.classList.add('text-accent-primary');
            if (direction === 'asc') {
                indicator.innerHTML = '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>';
            } else {
                indicator.innerHTML = '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>';
            }
        }
    }
}

function updateSortValue(recordId, fieldName, newValue) {
    const row = document.querySelector(`tr[data-record-id="${recordId}"]`);
    if (!row) return;
    
    // Map field names to sort column names
    const fieldToSortMap = {
        'date': 'date',
        'start_time': 'start_time',
        'end_time': 'end_time',
        'duration_hours': 'hours',
        'project_id': 'project',
        'task': 'task'
    };
    
    const sortColumn = fieldToSortMap[fieldName];
    if (!sortColumn) return;
    
    // Find the header to get column index
    const headers = Array.from(document.querySelectorAll('thead th'));
    let columnIndex = -1;
    headers.forEach((header, index) => {
        if (header.dataset.sort === sortColumn) {
            columnIndex = index;
        }
    });
    
    if (columnIndex === -1) return;
    
    const cells = row.querySelectorAll('td');
    if (columnIndex >= cells.length) return;
    
    const cell = cells[columnIndex];
    if (!cell) return;
    
    // Update data-sort-value based on field type
    if (fieldName === 'date') {
        cell.dataset.sortValue = newValue;
    } else if (fieldName === 'start_time' || fieldName === 'end_time') {
        cell.dataset.sortValue = newValue;
    } else if (fieldName === 'duration_hours') {
        cell.dataset.sortValue = parseFloat(newValue) || 0;
    } else if (fieldName === 'employee_id') {
        // Update employee name for sorting
        const select = cell.querySelector('select');
        if (select) {
            const selectedOption = select.options[select.selectedIndex];
            const employeeName = selectedOption ? selectedOption.text : 'ZZZZZZZZZZ';
            cell.dataset.sortValue = employeeName.toUpperCase();
        }
    } else if (fieldName === 'project_id') {
        // Update project name for sorting
        const select = cell.querySelector('select');
        if (select) {
            const selectedOption = select.options[select.selectedIndex];
            const projectName = selectedOption ? selectedOption.text : 'ZZZZZZZZZZ';
            cell.dataset.sortValue = projectName.toUpperCase();
        }
    } else if (fieldName === 'task') {
        cell.dataset.sortValue = (newValue || '').toUpperCase();
    }
}

// Function to calculate hours from start and end time
function calculateHoursFromTimes(recordId) {
    const row = document.querySelector(`tr[data-record-id="${recordId}"]`);
    if (!row) return null;
    
    const dateInput = row.querySelector(`input[data-field="date"]`);
    const startInput = row.querySelector(`input[data-field="start_time"]`);
    const endInput = row.querySelector(`input[data-field="end_time"]`);
    
    if (!dateInput || !startInput || !endInput) return null;
    
    const date = dateInput.value;
    const startTime = startInput.value;
    const endTime = endInput.value;
    
    if (!date || !startTime || !endTime) return null;
    
    try {
        // Parse date and times
        const startDateTime = new Date(`${date}T${startTime}`);
        let endDateTime = new Date(`${date}T${endTime}`);
        
        // If end time is before start time, assume next day
        if (endDateTime < startDateTime) {
            endDateTime = new Date(endDateTime.getTime() + 24 * 60 * 60 * 1000);
        }
        
        // Calculate difference in milliseconds
        const diffMs = endDateTime - startDateTime;
        const diffHours = diffMs / (1000 * 60 * 60);
        
        return Math.round(diffHours * 100) / 100; // Round to 2 decimal places
    } catch (e) {
        console.error('Error calculating hours:', e);
        return null;
    }
}

// Function to calculate end time from start time and hours
function calculateEndTimeFromHours(recordId, hours) {
    const row = document.querySelector(`tr[data-record-id="${recordId}"]`);
    if (!row) return null;
    
    const dateInput = row.querySelector(`input[data-field="date"]`);
    const startInput = row.querySelector(`input[data-field="start_time"]`);
    
    if (!dateInput || !startInput) return null;
    
    const date = dateInput.value;
    const startTime = startInput.value;
    
    if (!date || !startTime || !hours || isNaN(hours)) return null;
    
    try {
        const startDateTime = new Date(`${date}T${startTime}`);
        const endDateTime = new Date(startDateTime.getTime() + (hours * 60 * 60 * 1000));
        
        // Format as HH:MM:SS
        const hoursStr = String(endDateTime.getHours()).padStart(2, '0');
        const minutesStr = String(endDateTime.getMinutes()).padStart(2, '0');
        const secondsStr = String(endDateTime.getSeconds()).padStart(2, '0');
        
        return `${hoursStr}:${minutesStr}:${secondsStr}`;
    } catch (e) {
        console.error('Error calculating end time:', e);
        return null;
    }
}

// Track changes for all editable fields
document.querySelectorAll('.editable-field').forEach(field => {
    // Skip disabled fields
    if (field.disabled) {
        return;
    }
    
    const recordId = field.dataset.recordId;
    const fieldName = field.dataset.field;
    const originalValue = field.dataset.originalValue;
    
    // Initialize record in map if needed
    if (!changedRecords.has(recordId)) {
        changedRecords.set(recordId, {});
    }
    
    field.addEventListener('change', function() {
        // Skip disabled fields (like project for non-productive records)
        if (this.disabled) {
            return;
        }
        
        const newValue = this.value;
        const recordChanges = changedRecords.get(recordId);
        
        // If start_time, end_time, or date changed, recalculate hours
        if (fieldName === 'start_time' || fieldName === 'end_time' || fieldName === 'date') {
            const calculatedHours = calculateHoursFromTimes(recordId);
            if (calculatedHours !== null) {
                const hoursInput = document.querySelector(`input[data-record-id="${recordId}"][data-field="duration_hours"]`);
                if (hoursInput) {
                    const currentHoursValue = parseFloat(hoursInput.value) || 0;
                    const calculatedHoursRounded = Math.round(calculatedHours * 100) / 100;
                    
                    // Update the data attribute
                    hoursInput.dataset.calculatedHours = calculatedHoursRounded;
                    
                    // If hours weren't manually edited, update the value
                    if (!recordChanges.duration_hours) {
                        hoursInput.value = calculatedHoursRounded;
                        hoursInput.dataset.originalValue = calculatedHoursRounded;
                        // Update sort value for hours cell
                        const hoursCell = hoursInput.closest('td');
                        if (hoursCell) {
                            hoursCell.dataset.sortValue = calculatedHoursRounded;
                        }
                    }
                }
            }
        }
        
        // If hours changed, recalculate end_time
        if (fieldName === 'duration_hours') {
            const hours = parseFloat(newValue);
            if (!isNaN(hours) && hours >= 0) {
                const calculatedEndTime = calculateEndTimeFromHours(recordId, hours);
                if (calculatedEndTime !== null) {
                    const endInput = document.querySelector(`input[data-record-id="${recordId}"][data-field="end_time"]`);
                    if (endInput) {
                        const originalEndTime = endInput.dataset.originalValue;
                        
                        // Update end_time value
                        endInput.value = calculatedEndTime;
                        
                        // Update sort value for end_time cell
                        const endTimeCell = endInput.closest('td');
                        if (endTimeCell) {
                            endTimeCell.dataset.sortValue = calculatedEndTime;
                        }
                        
                        // Track end_time change if it's different from original
                        if (calculatedEndTime !== originalEndTime && !recordChanges.end_time) {
                            recordChanges.end_time = calculatedEndTime;
                            endInput.classList.add('border-accent-primary', 'bg-accent-primary/5');
                        }
                        
                    }
                }
            }
        }
        
        if (newValue !== originalValue) {
            recordChanges[fieldName] = newValue;
            this.classList.add('border-accent-primary', 'bg-accent-primary/5');
            
            // Update data-sort-value for the cell when field changes
            updateSortValue(recordId, fieldName, newValue);
        } else {
            delete recordChanges[fieldName];
            if (Object.keys(recordChanges).length === 0) {
                changedRecords.delete(recordId);
            }
            this.classList.remove('border-accent-primary', 'bg-accent-primary/5');
        }
        
        updateSaveButton();
    });
    
    field.addEventListener('blur', function() {
        const recordId = this.dataset.recordId;
        const recordChanges = changedRecords.get(recordId);
        if (!recordChanges || !recordChanges[this.dataset.field]) {
            this.classList.remove('border-accent-primary', 'bg-accent-primary/5');
        }
    });
});

// No initialization needed - calculated hours are rendered directly in the template

function updateSaveButton() {
    const saveButton = document.getElementById('saveAllButton');
    const saveText = document.getElementById('saveAllText');
    
    const totalChanges = changedRecords.size + deletedRecords.size;
    
    if (totalChanges > 0) {
        saveButton.disabled = false;
        saveText.textContent = 'Save All Changes';
    } else {
        saveButton.disabled = true;
        saveText.textContent = 'Save All Changes';
    }
}

function deleteRecord(recordId) {
    if (confirm('Are you sure you want to delete this record?')) {
        deletedRecords.add(recordId);
        // Hide the row
        const row = document.querySelector(`tr[data-record-id="${recordId}"]`);
        if (row) {
            row.style.opacity = '0.5';
            row.style.textDecoration = 'line-through';
        }
        updateSaveButton();
    }
}

function saveAllChanges() {
    const totalChanges = changedRecords.size + deletedRecords.size;
    if (totalChanges === 0) {
        return;
    }
    
    const button = document.getElementById('saveAllButton');
    const text = document.getElementById('saveAllText');
    const message = document.getElementById('saveMessage');
    
    button.disabled = true;
    text.textContent = 'Saving...';
    message.classList.add('hidden');
    
    // Collect all updates
    const updates = [];
    for (const [recordId, changes] of changedRecords.entries()) {
        if (deletedRecords.has(recordId)) {
            continue; // Skip if also marked for deletion
        }
        
        // Get current values from DOM (needed for date/time parsing)
        const row = document.querySelector(`tr[data-record-id="${recordId}"]`);
        if (!row) continue;
        
        const dateInput = row.querySelector(`input[data-field="date"]`);
        const startInput = row.querySelector(`input[data-field="start_time"]`);
        const endInput = row.querySelector(`input[data-field="end_time"]`);
        
        const updateData = { id: recordId };
        
        // If date or start_time changed, send both (needed for datetime parsing)
        if (changes.date || changes.start_time) {
            updateData.date = changes.date !== undefined ? changes.date : dateInput.value;
            updateData.start_time = changes.start_time !== undefined ? changes.start_time : startInput.value;
        }
        
        // If end_time changed, send it with date
        if (changes.end_time) {
            updateData.end_time = changes.end_time;
            if (!updateData.date) {
                updateData.date = changes.date !== undefined ? changes.date : dateInput.value;
            }
        }
        
        // Add all other changed fields
        for (const [field, value] of Object.entries(changes)) {
            if (field !== 'date' && field !== 'start_time' && field !== 'end_time') {
                updateData[field] = value;
            }
        }
        
        updates.push(updateData);
    }
    
    // Collect all deletes
    const deletes = Array.from(deletedRecords);
    
    // Send bulk request
    fetch('{% url "bulk_save_time_records" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify({
            updates: updates,
            deletes: deletes
        }),
        credentials: 'same-origin',
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update original values for updated records
            if (data.updated && data.updated.length > 0) {
                data.updated.forEach(recordData => {
                    const row = document.querySelector(`tr[data-record-id="${recordData.id}"]`);
                    if (row) {
                        row.querySelectorAll('.editable-field').forEach(field => {
                            const fieldName = field.dataset.field;
                            if (recordData[fieldName] !== undefined) {
                                if (fieldName === 'employee_id' || fieldName === 'project_id') {
                                    // For select fields, set the selected option
                                    field.value = recordData[fieldName];
                                } else {
                                    field.value = recordData[fieldName];
                                }
                                field.dataset.originalValue = recordData[fieldName];
                                field.classList.remove('border-accent-primary', 'bg-accent-primary/5');
                            }
                        });
                    }
                    changedRecords.delete(recordData.id);
                });
            }
            
            // Remove deleted rows
            if (data.deleted && data.deleted.length > 0) {
                data.deleted.forEach(recordId => {
                    const row = document.querySelector(`tr[data-record-id="${recordId}"]`);
                    if (row) {
                        row.remove();
                    }
                });
            }
            
            // Show success message
            const successCount = (data.updated ? data.updated.length : 0) + (data.deleted ? data.deleted.length : 0);
            const errorCount = data.errors ? data.errors.length : 0;
            
            if (errorCount === 0) {
                message.textContent = data.message || `Successfully saved ${successCount} change(s)!`;
                message.className = 'mt-3 text-sm text-center text-green-600 font-medium';
                message.classList.remove('hidden');
                
                // Clear deleted records set
                deletedRecords.clear();
                
                // Reload page after 1 second to show updated data
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                message.textContent = `Saved ${successCount} change(s), ${errorCount} error(s). Check console for details.`;
                message.className = 'mt-3 text-sm text-center text-yellow-600 font-medium';
                message.classList.remove('hidden');
                
                console.error('Errors:', data.errors);
            }
        } else {
            message.textContent = 'Error: ' + (data.error || 'Unknown error');
            message.className = 'mt-3 text-sm text-center text-red-600 font-medium';
            message.classList.remove('hidden');
            button.disabled = false;
            text.textContent = 'Save All Changes';
        }
        
        updateSaveButton();
    })
    .catch(error => {
        message.textContent = 'Error saving: ' + error.message;
        message.className = 'mt-3 text-sm text-center text-red-600 font-medium';
        message.classList.remove('hidden');
        button.disabled = false;
        text.textContent = 'Save All Changes';
        updateSaveButton();
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function getCSRFToken() {
    const metaTag = document.querySelector('meta[name=csrf-token]');
    if (metaTag) {
        return metaTag.getAttribute('content');
    }
    return getCookie('csrftoken');
}

// Initialize save button state
updateSaveButton();

// Initialize sorting
initSorting();

// Set values for hours inputs on page load (in case value attribute doesn't work)
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('input[data-field="duration_hours"]').forEach(input => {
        const placeholder = input.getAttribute('placeholder');
        if (placeholder && !input.value) {
            input.value = placeholder;
        }
    });
    
    // Initialize task dropdown based on type
    const typeSelect = document.getElementById('addRecordType');
    const taskSelect = document.getElementById('addRecordTask');
    const projectSelect = document.getElementById('addRecordProject');
    
    if (typeSelect && taskSelect) {
        updateTaskOptions(typeSelect.value);
        typeSelect.addEventListener('change', function() {
            updateTaskOptions(this.value);
            // Disable project field for non-productive records
            if (projectSelect) {
                const isNonProd = this.value === 'true';
                projectSelect.disabled = isNonProd;
                if (isNonProd) {
                    projectSelect.value = '';
                    projectSelect.classList.add('bg-slate-100', 'cursor-not-allowed', 'opacity-60');
                } else {
                    projectSelect.classList.remove('bg-slate-100', 'cursor-not-allowed', 'opacity-60');
                }
            }
        });
        
        // Initialize project field state
        if (projectSelect && typeSelect.value === 'true') {
            projectSelect.disabled = true;
            projectSelect.classList.add('bg-slate-100', 'cursor-not-allowed', 'opacity-60');
        }
    }
});

// Add Record Modal Functions
function openAddRecordModal() {
    const modal = document.getElementById('addRecordModal');
    if (modal) {
        modal.classList.remove('hidden');
        // Set today's date as default
        const dateInput = document.querySelector('#addRecordForm input[name="date"]');
        if (dateInput && !dateInput.value) {
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
        }
        
        // Reset project field state based on type
        const typeSelect = document.getElementById('addRecordType');
        const projectSelect = document.getElementById('addRecordProject');
        if (typeSelect && projectSelect) {
            const isNonProd = typeSelect.value === 'true';
            projectSelect.disabled = isNonProd;
            if (isNonProd) {
                projectSelect.value = '';
                projectSelect.classList.add('bg-slate-100', 'cursor-not-allowed', 'opacity-60');
            } else {
                projectSelect.classList.remove('bg-slate-100', 'cursor-not-allowed', 'opacity-60');
            }
        }
    }
}

function closeAddRecordModal() {
    const modal = document.getElementById('addRecordModal');
    if (modal) {
        modal.classList.add('hidden');
        document.getElementById('addRecordForm').reset();
    }
}

// Top-up to 6.91h modal
let topupSuggestions = [];

function openTopupModal() {
    const modal = document.getElementById('topupModal');
    if (!modal) return;
    const form = document.getElementById('editRecordsFilterForm');
    const dateFrom = form ? form.querySelector('input[name="date_from"]').value : '';
    const dateTo = form ? form.querySelector('input[name="date_to"]').value : '';
    const employee = form ? (form.querySelector('select[name="employee"]') || {}).value || '' : '';
    if (!dateFrom || !dateTo) {
        alert('Please set Date From and Date To in the filters.');
        return;
    }
    modal.classList.remove('hidden');
    document.getElementById('topupLoading').classList.remove('hidden');
    document.getElementById('topupEmpty').classList.add('hidden');
    document.getElementById('topupTableWrap').classList.add('hidden');
    document.getElementById('topupFooter').classList.add('hidden');
    const params = new URLSearchParams({ date_from: dateFrom, date_to: dateTo });
    if (employee) params.set('employee', employee);
    fetch('{% url "topup_preview" %}' + '?' + params.toString(), { method: 'GET', credentials: 'same-origin' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            document.getElementById('topupLoading').classList.add('hidden');
            if (!data.success) {
                document.getElementById('topupEmpty').classList.remove('hidden');
                document.getElementById('topupEmpty').textContent = data.error || 'Failed to load preview.';
                return;
            }
            topupSuggestions = data.suggestions || [];
            if (topupSuggestions.length === 0) {
                document.getElementById('topupEmpty').classList.remove('hidden');
                return;
            }
            const s = data.summary || {};
            document.getElementById('topupSummary').textContent =
                (s.employees_affected || 0) + ' employee(s), ' + (s.days_affected || 0) + ' day(s), ' + topupSuggestions.length + ' record(s) to update.';
            const tbody = document.getElementById('topupTableBody');
            tbody.innerHTML = '';
            topupSuggestions.forEach(function(row) {
                const tr = document.createElement('tr');
                function addCell(text, cls, isHtml) {
                    const td = document.createElement('td');
                    td.className = cls || 'px-2 py-1.5';
                    if (isHtml) td.innerHTML = text; else td.textContent = text || '';
                    tr.appendChild(td);
                }
                addCell(row.employee_name, 'px-2 py-1.5');
                addCell(row.date, 'px-2 py-1.5');
                addCell(row.task, 'px-2 py-1.5');
                addCell(row.project_name || '-', 'px-2 py-1.5');
                var typeHtml = '<span class="px-1.5 py-0.5 rounded text-[10px] font-semibold ' + (row.is_non_productive ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700') + '">' + (row.is_non_productive ? 'Non-Prod' : 'Productive') + '</span>';
                addCell(typeHtml, 'px-2 py-1.5', true);
                addCell(Number(row.current_hours).toFixed(2), 'px-2 py-1.5 text-right');
                addCell('+' + Number(row.add_hours).toFixed(2), 'px-2 py-1.5 text-right text-amber-700 font-medium');
                addCell(Number(row.new_hours).toFixed(2), 'px-2 py-1.5 text-right font-semibold');
                tbody.appendChild(tr);
            });
            document.getElementById('topupTableWrap').classList.remove('hidden');
            document.getElementById('topupFooter').classList.remove('hidden');
        })
        .catch(function(err) {
            document.getElementById('topupLoading').classList.add('hidden');
            document.getElementById('topupEmpty').classList.remove('hidden');
            document.getElementById('topupEmpty').textContent = 'Error: ' + (err.message || 'Could not load preview.');
        });
}

function closeTopupModal() {
    const modal = document.getElementById('topupModal');
    if (modal) modal.classList.add('hidden');
}

function applyTopup() {
    if (!topupSuggestions.length) return;
    const btn = document.getElementById('topupApplyBtn');
    const orig = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Applying…';
    const updates = topupSuggestions.map(function(s) { return { record_id: s.record_id, add_hours: s.add_hours }; });
    fetch('{% url "topup_apply" %}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
        body: JSON.stringify({ updates: updates }),
        credentials: 'same-origin'
    })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                closeTopupModal();
                window.location.reload();
            } else {
                alert('Error: ' + (data.error || 'Apply failed.'));
                btn.disabled = false;
                btn.textContent = orig;
            }
        })
        .catch(function(err) {
            alert('Error: ' + (err.message || 'Request failed.'));
            btn.disabled = false;
            btn.textContent = orig;
        });
}

// Task options from server
const productiveTasks = [
    {% for task in productive_tasks %}"{{ task.name|escapejs }}"{% if not forloop.last %}, {% endif %}{% endfor %}
];
const nonProductiveTasks = [
    {% for task in non_productive_tasks %}"{{ task.name|escapejs }}"{% if not forloop.last %}, {% endif %}{% endfor %}
];

function updateTaskOptions(isNonProductive) {
    const taskSelect = document.getElementById('addRecordTask');
    if (!taskSelect) return;
    
    // Clear existing options except the first one
    while (taskSelect.options.length > 1) {
        taskSelect.remove(1);
    }
    
    // Add appropriate tasks based on type
    const isNonProd = isNonProductive === 'true';
    const tasks = isNonProd ? nonProductiveTasks : productiveTasks;
    
    tasks.forEach(taskName => {
        const option = document.createElement('option');
        option.value = taskName;
        option.textContent = taskName;
        taskSelect.appendChild(option);
    });
}

// Handle add record form submission
document.getElementById('addRecordForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {};
    for (const [key, value] of formData.entries()) {
        data[key] = value;
    }
    
    // Validate required fields
    if (!data.date || !data.employee_id || !data.task || !data.start_time) {
        alert('Please fill in all required fields');
        return;
    }
    
    // Calculate hours if end_time is provided
    if (data.end_time && data.start_time && data.date) {
        try {
            const startDateTime = new Date(`${data.date}T${data.start_time}`);
            let endDateTime = new Date(`${data.date}T${data.end_time}`);
            if (endDateTime < startDateTime) {
                endDateTime = new Date(endDateTime.getTime() + 24 * 60 * 60 * 1000);
            }
            const diffMs = endDateTime - startDateTime;
            const diffHours = diffMs / (1000 * 60 * 60);
            if (!data.duration_hours || data.duration_hours === '') {
                data.duration_hours = Math.round(diffHours * 100) / 100;
            }
        } catch (e) {
            console.error('Error calculating hours:', e);
        }
    }
    
    // Convert is_non_productive to boolean
    data.is_non_productive = data.is_non_productive === 'true';
    
    // Disable submit button
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Adding...';
    
    fetch('{% url "create_time_record" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify(data),
        credentials: 'same-origin',
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeAddRecordModal();
            // Reload page to show new record
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to create record'));
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    });
});

// Close modal when clicking outside
document.getElementById('addRecordModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeAddRecordModal();
    }
});
document.getElementById('topupModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeTopupModal();
    }
});
</script>
{% endblock %}
