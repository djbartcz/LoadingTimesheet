{% extends "base.html" %}
{% load timesheet_tags %}

{% block extra_head %}
<script>
    const employeeId = '{{ employee.id }}';
    const STORAGE_KEY = 'timesheet_active_timer_' + employeeId;
    
    // Get timer data - prefer database, fallback to localStorage
    let activeTimer = {% if active_timer %}{
        id: '{{ active_timer.id }}',
        start_time: '{{ active_timer.start_time }}',
        is_non_productive: {{ active_timer.is_non_productive|lower }},
        is_break: {{ active_timer.is_break|lower }},
        employee_id: '{{ employee.id }}'
    }{% else %}null{% endif %};
    
    // Load from localStorage if available (for offline support)
    function loadTimerFromStorage() {
        try {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                const parsed = JSON.parse(stored);
                // Only use if it's for this employee
                if (parsed.employee_id === employeeId) {
                    return parsed;
                }
            }
        } catch (e) {
            console.error('Error loading timer from storage:', e);
        }
        return null;
    }
    
    // Save timer to localStorage
    function saveTimerToStorage(timerData) {
        try {
            if (timerData) {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(timerData));
            } else {
                localStorage.removeItem(STORAGE_KEY);
            }
        } catch (e) {
            console.error('Error saving timer to storage:', e);
        }
    }
    
    // Sync timer with server (check if still active)
    async function syncTimerWithServer() {
        if (!navigator.onLine) {
            updateConnectionStatus(false);
            return false;
        }
        
        try {
            const response = await fetch(window.location.origin + '/employee/' + employeeId + '/', {
                method: 'GET',
                headers: { 
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                updateConnectionStatus(true);
                
                if (data.has_timer && data.timer) {
                    // Timer still exists on server - update local storage
                    const serverTimer = {
                        id: data.timer.id,
                        start_time: data.timer.start_time,
                        is_non_productive: data.timer.is_non_productive,
                        is_break: data.timer.is_break,
                        employee_id: employeeId
                    };
                    
                    // Update if start_time changed (shouldn't happen, but safety check)
                    if (activeTimer && activeTimer.start_time !== serverTimer.start_time) {
                        console.warn('Timer start_time mismatch - using server value');
                        activeTimer = serverTimer;
                        saveTimerToStorage(serverTimer);
                    } else if (!activeTimer) {
                        // Server has timer but we don't - restore it
                        activeTimer = serverTimer;
                        saveTimerToStorage(serverTimer);
                    }
                } else {
                    // Timer was stopped on server - clear local storage
                    if (activeTimer) {
                        console.log('Timer stopped on server - clearing local storage');
                        activeTimer = null;
                        saveTimerToStorage(null);
                        // Reload page to reflect stopped timer
                        window.location.reload();
                    }
                }
                return true;
            }
        } catch (e) {
            console.log('Sync check failed (offline or error):', e);
            updateConnectionStatus(false);
        }
        return false;
    }
    
    // Update connection status indicator
    function updateConnectionStatus(isOnline) {
        let statusEl = document.getElementById('connection-status');
        if (!statusEl && isOnline === false) {
            // Create status indicator if offline
            statusEl = document.createElement('div');
            statusEl.id = 'connection-status';
            statusEl.className = 'fixed top-0 left-0 right-0 bg-yellow-100 border-b border-yellow-300 text-yellow-800 text-xs text-center py-1 z-50';
            statusEl.textContent = '⚠ Offline - Timer continues counting';
            document.body.insertBefore(statusEl, document.body.firstChild);
        } else if (statusEl && isOnline) {
            // Remove status indicator when online
            statusEl.remove();
        }
    }
    
    // Initialize timer data
    const storedTimer = loadTimerFromStorage();
    if (activeTimer) {
        // Database has timer - save to localStorage and use it
        saveTimerToStorage(activeTimer);
    } else if (storedTimer) {
        // No database timer, but we have stored one - use stored (offline mode)
        activeTimer = storedTimer;
        console.log('Using stored timer (offline mode):', storedTimer);
    }
    
    // Update timer display every second
    let timerInterval = null;
    let syncInterval = null;
    
    function updateTimer() {
        const timerDisplay = document.getElementById('timer-display');
        if (!timerDisplay) return;
        
        if (!activeTimer || !activeTimer.start_time) {
            timerDisplay.textContent = '00:00:00';
            return;
        }
        
        try {
            const startTimeStr = activeTimer.start_time;
            
            if (!startTimeStr || startTimeStr === 'None' || startTimeStr.trim() === '') {
                timerDisplay.textContent = '00:00:00';
                return;
            }
            
            const startTime = new Date(startTimeStr);
            
            if (isNaN(startTime.getTime())) {
                console.error('Invalid start time:', startTimeStr);
                timerDisplay.textContent = '00:00:00';
                return;
            }
            
            // Calculate elapsed time using client's current time
            // This works offline because we're comparing two Date objects
            const now = new Date();
            const elapsed = Math.floor((now - startTime) / 1000);
            
            if (elapsed < 0) {
                timerDisplay.textContent = '00:00:00';
                return;
            }
            
            const hours = Math.floor(elapsed / 3600);
            const minutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;
            
            timerDisplay.textContent = 
                String(hours).padStart(2, '0') + ':' + 
                String(minutes).padStart(2, '0') + ':' + 
                String(seconds).padStart(2, '0');
        } catch (error) {
            console.error('Timer update error:', error);
            const timerDisplay = document.getElementById('timer-display');
            if (timerDisplay) {
                timerDisplay.textContent = '00:00:00';
            }
        }
    }
    
    // Start timer when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        if (activeTimer) {
            // Timer is active - start counting
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
            
            // Sync with server every 30 seconds (only when online)
            // This ensures timer stays in sync with database
            syncInterval = setInterval(function() {
                if (navigator.onLine) {
                    syncTimerWithServer();
                }
            }, 30000);
            
            // Initial sync check
            if (navigator.onLine) {
                syncTimerWithServer();
            } else {
                updateConnectionStatus(false);
            }
        } else {
            const timerDisplay = document.getElementById('timer-display');
            if (timerDisplay) {
                timerDisplay.textContent = '00:00:00';
            }
            // Clear any stale storage
            saveTimerToStorage(null);
        }
    });
    
    // Handle online/offline events
    window.addEventListener('online', function() {
        console.log('Connection restored - syncing timer');
        syncTimerWithServer();
    });
    
    window.addEventListener('offline', function() {
        console.log('Connection lost - timer continues offline');
    });
    
    // Clean up intervals when page unloads
    window.addEventListener('beforeunload', function() {
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        if (syncInterval) {
            clearInterval(syncInterval);
        }
    });
    
    function formatDuration(seconds) {
        if (!seconds || isNaN(seconds)) return '0min';
        const hrs = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        if (hrs > 0) return `${hrs}h ${mins}min`;
        return `${mins}min`;
    }
    
    {% if summary %}
    document.addEventListener('DOMContentLoaded', function() {
        const todayTotal = document.getElementById('today-total');
        const weekTotal = document.getElementById('week-total');
        if (todayTotal) {
            todayTotal.textContent = formatDuration({{ summary.today.total_seconds|default:0 }});
        }
        if (weekTotal) {
            weekTotal.textContent = formatDuration({{ summary.week.total_seconds|default:0 }});
        }
    });
    {% endif %}
</script>
{% endblock %}

{% block content %}
<div class="min-h-screen px-3 sm:px-4 pt-12 sm:pt-14 pb-5 max-w-[500px] mx-auto flex flex-col gap-2.5 sm:gap-3">
    <!-- Header -->
    <div class="flex items-center justify-between py-2">
        <a href="{% url 'employee_selection' %}" class="text-accent-primary text-sm sm:text-base font-medium hover:underline active:opacity-70">← Zpět</a>
        <div class="flex items-center gap-1.5 sm:gap-2 bg-blue-50 px-2.5 sm:px-3.5 py-1.5 sm:py-2 rounded-full">
            <svg class="w-4 h-4 sm:w-[18px] sm:h-[18px] text-accent-primary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            <span class="font-semibold text-accent-primary text-xs sm:text-sm truncate max-w-[120px] sm:max-w-none">{{ employee.name }}</span>
        </div>
    </div>

    <!-- Today Summary -->
    {% if summary and not active_timer %}
    <div class="flex items-center gap-2 sm:gap-3 p-2.5 sm:p-3 bg-white border border-slate-200 rounded-xl">
        <div class="flex flex-col">
            <span class="text-[10px] sm:text-[11px] text-slate-400 uppercase">Dnes</span>
            <span class="font-grotesk text-sm sm:text-base font-bold text-accent-primary" id="today-total">0min</span>
        </div>
        <div class="flex flex-col">
            <span class="text-[10px] sm:text-[11px] text-slate-400 uppercase">Tento týden</span>
            <span class="font-grotesk text-sm sm:text-base font-bold text-accent-primary" id="week-total">0min</span>
        </div>
        <button onclick="document.getElementById('history-panel').classList.toggle('hidden')" class="ml-auto bg-slate-50 border border-slate-200 rounded-lg p-1.5 sm:p-2 text-slate-600 hover:bg-slate-100 transition-colors cursor-pointer active:scale-95">
            <svg class="w-4 h-4 sm:w-4.5 sm:h-4.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
        </button>
    </div>
    {% endif %}

    <!-- History Panel -->
    <div id="history-panel" class="hidden bg-white border border-slate-200 rounded-xl p-4 max-h-[200px] overflow-y-auto">
        <h3 class="text-sm font-semibold mb-3 text-slate-600">Dnešní záznamy</h3>
        <div id="history-list">
            {% for record in summary.today.records %}
            <div class="flex items-center p-2 bg-slate-50 rounded-lg mb-1.5 {% if record.is_non_productive %}border-l-3 border-accent-orange{% elif record.is_break %}border-l-3 border-accent-purple{% endif %}">
                <div class="flex-1 flex justify-between items-center">
                    <span class="text-[13px] font-medium">{{ record.project_name|default:record.task }}</span>
                    <span class="text-[13px] text-slate-400">{{ record.duration_seconds|format_duration_seconds }}</span>
                </div>
            </div>
            {% empty %}
            <p class="text-slate-400 text-sm text-center py-4">Žádné záznamy</p>
            {% endfor %}
        </div>
    </div>

    <!-- Timer Card -->
    <div class="bg-white border-2 rounded-2xl {% if active_timer %}{% if active_timer.is_break %}border-accent-purple bg-gradient-to-b from-purple-50 {% elif active_timer.is_non_productive %}border-accent-orange bg-gradient-to-b from-orange-50 {% else %}border-accent-success bg-gradient-to-b from-green-50 {% endif %}{% else %}border-slate-200{% endif %}">
        <div class="p-3 sm:p-4 border-b border-slate-200">
            <div class="flex items-center gap-1.5 sm:gap-2 font-grotesk text-sm sm:text-base">
                {% if active_timer and active_timer.is_break %}
                <svg class="w-4 h-4 sm:w-5 sm:h-5 text-accent-purple pulse-animation flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                {% else %}
                <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0 {% if active_timer %}{% if active_timer.is_non_productive %}text-accent-orange pulse-animation {% else %}text-accent-success pulse-animation {% endif %}{% else %}text-accent-primary{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                {% endif %}
                <span>{% if active_timer and active_timer.is_break %}Přestávka{% else %}Časomíra{% endif %}</span>
            </div>
        </div>
        <div class="p-2.5 sm:p-3">
            <div class="font-grotesk text-[44px] sm:text-[52px] font-bold text-center py-2 sm:py-3 tracking-[1px] sm:tracking-[2px] timer-display-mobile" id="timer-display">00:00:00</div>
            {% if active_timer %}
            <div class="flex flex-col gap-1.5 p-2.5 sm:p-3 rounded-lg mt-1 {% if active_timer.is_break %}bg-purple-100 {% elif active_timer.is_non_productive %}bg-orange-100 {% else %}bg-green-100 {% endif %}">
                {% if not active_timer.is_break %}
                <div class="flex items-center gap-1.5 sm:gap-2 text-slate-600 font-medium text-xs sm:text-sm">
                    {% if active_timer.is_non_productive %}
                    <svg class="w-3.5 h-3.5 sm:w-4.5 sm:h-4.5 text-accent-orange flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    {% else %}
                    <svg class="w-3.5 h-3.5 sm:w-4.5 sm:h-4.5 text-accent-success flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    {% endif %}
                    <span class="truncate">{{ active_timer.project_name|default:active_timer.task }}</span>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Quick Repeat Last Task -->
    {% if last_task and not active_timer and not last_task.is_break %}
    <form method="post" action="{% url 'start_timer' employee.id %}">
        {% csrf_token %}
        <input type="hidden" name="mode" value="{% if last_task.is_non_productive %}non-productive{% else %}productive{% endif %}">
        {% if not last_task.is_non_productive %}
        <input type="hidden" name="project_id" value="{{ last_task.project_id }}">
        <input type="hidden" name="project_name" value="{{ last_task.project_name }}">
        {% endif %}
        <input type="hidden" name="task" value="{{ last_task.task }}">
        <input type="hidden" name="non_productive_task" value="{{ last_task.task }}">
        <button type="submit" class="w-full flex items-center gap-2 sm:gap-3 p-3 sm:p-3.5 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-accent-success rounded-xl hover:shadow-sm transition-all active:scale-[0.98]">
            <svg class="w-4 h-4 sm:w-5 sm:h-5 text-accent-success flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            <div class="flex-1 flex flex-col items-start min-w-0">
                <span class="text-[10px] sm:text-xs text-accent-success font-semibold uppercase">Pokračovat v posledním</span>
                <span class="text-xs sm:text-sm font-semibold truncate w-full">{{ last_task.project_name|default:last_task.task }}</span>
            </div>
            <svg class="w-4 h-4 sm:w-5 sm:h-5 text-accent-success flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
        </button>
    </form>
    {% endif %}

    <!-- Mode Toggle -->
    {% if not active_timer %}
    <div class="flex gap-1 sm:gap-1.5 bg-white p-0.5 sm:p-1 rounded-[10px] border border-slate-200">
        <button onclick="setMode('productive')" id="mode-productive" class="flex-1 flex items-center justify-center gap-1.5 sm:gap-2 px-2 sm:px-3.5 py-2 sm:py-3 bg-accent-primary text-white rounded-[7px] font-grotesk text-xs sm:text-sm font-semibold transition-all hover:bg-opacity-90 active:scale-[0.98]">
            <svg class="w-3.5 h-3.5 sm:w-4.5 sm:h-4.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
            <span class="hidden sm:inline">Produktivní</span>
            <span class="sm:hidden">Prod.</span>
        </button>
        <button onclick="setMode('non-productive')" id="mode-nonproductive" class="flex-1 flex items-center justify-center gap-1.5 sm:gap-2 px-2 sm:px-3.5 py-2 sm:py-3 bg-transparent text-slate-600 rounded-[7px] font-grotesk text-xs sm:text-sm font-semibold hover:bg-slate-50 transition-all active:scale-[0.98]">
            <svg class="w-3.5 h-3.5 sm:w-4.5 sm:h-4.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <span class="hidden sm:inline">Neproduktivní</span>
            <span class="sm:hidden">Neprod.</span>
        </button>
    </div>
    {% endif %}

    <!-- Selection Controls -->
    {% if not active_timer %}
    <form method="post" action="{% url 'start_timer' employee.id %}" id="timer-form">
        {% csrf_token %}
        <input type="hidden" name="mode" id="form-mode" value="productive">
        <input type="hidden" name="project_id" id="form-project-id">
        <input type="hidden" name="project_name" id="form-project-name">
        <input type="hidden" name="task" id="form-task">
        <input type="hidden" name="non_productive_task" id="form-nonproductive-task">
        
        <div id="productive-section" class="hidden flex flex-col gap-3">
            <button type="button" onclick="showProjectModal()" class="flex items-center justify-between w-full p-2.5 sm:p-3 bg-white border-2 border-slate-200 rounded-xl hover:border-accent-primary transition-all active:scale-[0.98]">
                <div class="flex items-center gap-2 sm:gap-2.5 min-w-0 flex-1">
                    <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-accent-primary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    <div class="flex flex-col items-start min-w-0 flex-1">
                        <span class="text-[10px] sm:text-xs text-slate-400 uppercase leading-tight">Projekt</span>
                        <span class="text-xs sm:text-sm font-semibold truncate w-full leading-tight" id="selected-project-name">Vyberte projekt...</span>
                    </div>
                </div>
                <svg class="w-4 h-4 sm:w-5 sm:h-5 text-slate-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>
            <div class="bg-white border border-slate-200 rounded-xl">
                <div class="p-3 sm:p-4 border-b border-slate-200">
                    <div class="flex items-center gap-1.5 sm:gap-2 font-grotesk text-sm sm:text-base">
                        <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-accent-primary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                        <span>Úkon</span>
                    </div>
                </div>
                <div class="p-2.5 sm:p-3">
                    <div class="grid grid-cols-2 gap-2 task-grid-mobile">
                        {% for task in tasks %}
                        <button type="button" onclick="selectTask('{{ task.name }}')" class="task-btn p-2.5 sm:p-3.5 bg-slate-50 border-2 border-slate-200 rounded-lg font-grotesk text-xs sm:text-[13px] font-semibold text-slate-600 hover:border-accent-primary hover:text-accent-primary transition-all cursor-pointer active:scale-[0.98]" data-task="{{ task.name }}">
                            {{ task.name }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div id="nonproductive-section" class="hidden flex flex-col gap-3">
            <div class="bg-white border border-orange-200 rounded-xl">
                <div class="p-3 sm:p-4 border-b border-slate-200">
                    <div class="flex items-center gap-1.5 sm:gap-2 font-grotesk text-sm sm:text-base">
                        <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-accent-orange flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <span>Neproduktivní úkon</span>
                    </div>
                </div>
                <div class="p-2.5 sm:p-3">
                    <div class="grid grid-cols-2 gap-2 task-grid-mobile">
                        {% for task in non_productive_tasks %}
                        <button type="button" onclick="selectNonProductiveTask('{{ task.name }}')" class="task-btn-np p-2.5 sm:p-3.5 bg-slate-50 border-2 border-slate-200 rounded-lg font-grotesk text-xs sm:text-[13px] font-semibold text-slate-600 hover:border-accent-orange hover:text-accent-orange transition-all cursor-pointer active:scale-[0.98]" data-task="{{ task.name }}">
                            {{ task.name }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </form>
    {% endif %}

    <!-- Action Buttons -->
    <div class="mt-auto pt-2 sm:pt-3 pb-4 sm:pb-5">
        {% if active_timer %}
        <form method="post" action="{% url 'stop_timer' employee.id %}">
            {% csrf_token %}
            <button type="submit" class="w-full h-14 sm:h-16 text-lg sm:text-xl font-bold font-grotesk bg-accent-danger text-white rounded-xl flex items-center justify-center gap-2 sm:gap-2.5 hover:bg-red-600 transition-all active:scale-[0.98]">
                <svg class="w-5 h-5 sm:w-6 sm:h-6 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd"></path>
                </svg>
                STOP
            </button>
        </form>
        {% else %}
        <button onclick="submitTimerForm()" id="start-btn" disabled class="w-full h-14 sm:h-16 text-lg sm:text-xl font-bold font-grotesk bg-accent-primary text-white rounded-xl flex items-center justify-center gap-2 sm:gap-2.5 hover:bg-accent-secondary transition-all disabled:opacity-50 disabled:cursor-not-allowed active:scale-[0.98]">
            <svg class="w-5 h-5 sm:w-6 sm:h-6 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path>
            </svg>
            START
        </button>
        {% endif %}
    </div>
</div>

<!-- Project Modal -->
<div id="project-modal" class="hidden fixed inset-0 bg-slate-50 z-50 flex flex-col modal-slide-up">
    <div class="flex items-center justify-between p-4 bg-white border-b border-slate-200">
        <h2 class="font-grotesk text-lg font-bold">Vyberte projekt</h2>
        <button onclick="hideProjectModal()" class="text-slate-600 p-2">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>
    <div class="flex items-center gap-3 p-3 bg-white border-b border-slate-200">
        <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <input type="text" id="project-search" placeholder="Hledat projekt..." class="flex-1 border-none bg-transparent text-base outline-none" oninput="filterProjects(this.value)">
    </div>
    <div class="flex-1 overflow-y-auto p-2">
        {% for project in projects %}
        <button onclick="selectProject('{{ project.id }}', '{{ project.name|escapejs }}')" class="project-item w-full flex items-center justify-between p-4 bg-white border-2 border-slate-200 rounded-xl mb-2 text-left hover:border-accent-primary transition-all" data-project-id="{{ project.id }}" data-project-name="{{ project.name }}">
            <div class="flex flex-col gap-0.5">
                <span class="text-xs text-slate-400">{{ project.id }}</span>
                <span class="text-sm font-semibold">{{ project.name }}</span>
            </div>
            <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </button>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let currentMode = 'productive';
    let selectedProject = null;
    let selectedTask = null;
    let selectedNonProductiveTask = null;
    
    function setMode(mode) {
        currentMode = mode;
        document.getElementById('form-mode').value = mode;
        
        if (mode === 'productive') {
            document.getElementById('mode-productive').classList.add('bg-accent-primary', 'text-white');
            document.getElementById('mode-productive').classList.remove('bg-transparent', 'text-slate-600');
            document.getElementById('mode-nonproductive').classList.remove('bg-accent-primary', 'text-white');
            document.getElementById('mode-nonproductive').classList.add('bg-transparent', 'text-slate-600');
            document.getElementById('productive-section').classList.remove('hidden');
            document.getElementById('nonproductive-section').classList.add('hidden');
        } else {
            document.getElementById('mode-nonproductive').classList.add('bg-accent-orange', 'text-white');
            document.getElementById('mode-nonproductive').classList.remove('bg-transparent', 'text-slate-600');
            document.getElementById('mode-productive').classList.remove('bg-accent-primary', 'text-white');
            document.getElementById('mode-productive').classList.add('bg-transparent', 'text-slate-600');
            document.getElementById('nonproductive-section').classList.remove('hidden');
            document.getElementById('productive-section').classList.add('hidden');
        }
        updateStartButton();
    }
    
    function selectProject(id, name) {
        selectedProject = {id: id, name: name};
        document.getElementById('form-project-id').value = id;
        document.getElementById('form-project-name').value = name;
        document.getElementById('selected-project-name').textContent = name;
        hideProjectModal();
        updateStartButton();
    }
    
    function selectTask(task) {
        selectedTask = task;
        document.getElementById('form-task').value = task;
        document.querySelectorAll('.task-btn').forEach(btn => {
            btn.classList.remove('bg-accent-primary', 'border-accent-primary', 'text-white');
            btn.classList.add('bg-slate-50', 'border-slate-200', 'text-slate-600');
        });
        event.target.classList.add('bg-accent-primary', 'border-accent-primary', 'text-white');
        event.target.classList.remove('bg-slate-50', 'border-slate-200', 'text-slate-600');
        updateStartButton();
    }
    
    function selectNonProductiveTask(task) {
        selectedNonProductiveTask = task;
        document.getElementById('form-nonproductive-task').value = task;
        document.querySelectorAll('.task-btn-np').forEach(btn => {
            btn.classList.remove('bg-accent-orange', 'border-accent-orange', 'text-white');
            btn.classList.add('bg-slate-50', 'border-slate-200', 'text-slate-600');
        });
        event.target.classList.add('bg-accent-orange', 'border-accent-orange', 'text-white');
        event.target.classList.remove('bg-slate-50', 'border-slate-200', 'text-slate-600');
        updateStartButton();
    }
    
    function updateStartButton() {
        const btn = document.getElementById('start-btn');
        if (currentMode === 'productive') {
            btn.disabled = !selectedProject || !selectedTask;
        } else {
            btn.disabled = !selectedNonProductiveTask;
        }
    }
    
    function submitTimerForm() {
        if (!document.getElementById('start-btn').disabled) {
            document.getElementById('timer-form').submit();
        }
    }
    
    function showProjectModal() {
        document.getElementById('project-modal').classList.remove('hidden');
    }
    
    function hideProjectModal() {
        document.getElementById('project-modal').classList.add('hidden');
    }
    
    function filterProjects(search) {
        const items = document.querySelectorAll('.project-item');
        const searchLower = search.toLowerCase();
        items.forEach(item => {
            const name = item.dataset.projectName.toLowerCase();
            const id = item.dataset.projectId.toLowerCase();
            if (name.includes(searchLower) || id.includes(searchLower)) {
                item.classList.remove('hidden');
            } else {
                item.classList.add('hidden');
            }
        });
    }
    
    // Initialize mode
    {% if not active_timer %}
    setMode('productive');
    {% endif %}
</script>
{% endblock %}
